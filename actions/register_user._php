<?php
// actions/register_user.php
session_start();

require_once '../includes/config/config.php';
require_once '../database.php'; // getMasterConnection()

// --- CONFIGURAÇÃO TURNSTILE (CAPTCHA) ---
// Coloque aqui sua SECRET KEY do Cloudflare Turnstile
define('TURNSTILE_SECRET_KEY', 'SUA_SECRET_KEY_AQUI');

function verificarTurnstile($token) {
    if (!$token) return false;
    
    $url = "https://challenges.cloudflare.com/turnstile/v0/siteverify";
    $data = [
        'secret' => TURNSTILE_SECRET_KEY,
        'response' => $token,
        'remoteip' => $_SERVER['REMOTE_ADDR']
    ];

    $options = [
        'http' => [
            'header'  => "Content-type: application/x-www-form-urlencoded\r\n",
            'method'  => 'POST',
            'content' => http_build_query($data)
        ]
    ];
    $context  = stream_context_create($options);
    $result = file_get_contents($url, false, $context);
    $response = json_decode($result);

    return $response->success;
}

// --- Captura segura dos dados enviados ---
$dados = $_POST ?? [];

$nome        = trim($dados['nome'] ?? '');
$email       = trim($dados['email'] ?? '');
$senha       = trim($dados['senha'] ?? '');
$tipo_pessoa = trim($dados['tipo_pessoa'] ?? '');
$documento   = trim($dados['documento'] ?? '');
$telefone    = trim($dados['telefone'] ?? '');
$turnstileToken = $dados['cf-turnstile-response'] ?? '';

// --- Validação Básica ---
if (!$nome || !$email || !$senha) {
    $_SESSION['erro_registro'] = "Preencha todos os campos obrigatórios.";
    $_SESSION['form_data'] = $_POST; // Guarda dados para não perder
    header("Location: ../pages/registro.php");
    exit;
}

// --- Validação Anti-Robô ---
if (!verificarTurnstile($turnstileToken)) {
    $_SESSION['erro_registro'] = "Verificação de segurança falhou. Por favor, tente novamente.";
    $_SESSION['form_data'] = $_POST;
    header("Location: ../pages/registro.php");
    exit;
}

// --- Criptografa senha ---
$senha_hash = password_hash($senha, PASSWORD_DEFAULT);

// --- Conecta no banco master ---
$conn = getMasterConnection();
if ($conn->connect_error) {
    error_log("⛔ ERRO REGISTER_USER: Falha ao conectar ao banco master: " . $conn->connect_error);
    $_SESSION['erro_registro'] = "Erro de conexão interna. Tente novamente.";
    header("Location: ../pages/registro.php?msg=dberror");
    exit;
}

// --- VERIFICAÇÃO RIGOROSA DE DUPLICIDADE (CPF/CNPJ E EMAIL) ---
// Verifica na tabela de usuarios se já existe o email OU o documento
$stmtCheck = $conn->prepare("SELECT id FROM usuarios WHERE email = ? OR documento = ? LIMIT 1");
$stmtCheck->bind_param("ss", $email, $documento);
$stmtCheck->execute();
$stmtCheck->store_result();

if ($stmtCheck->num_rows > 0) {
    $stmtCheck->close();
    $_SESSION['erro_registro'] = "Este E-mail ou CPF/CNPJ já está cadastrado no sistema.";
    $_SESSION['form_data'] = $_POST;
    header("Location: ../pages/registro.php?msg=dados_duplicados");
    exit;
}
$stmtCheck->close();

// Variáveis para o try/catch
$usuarioMasterId = null;
$tenantId = null;
$dbName = null;
$tenantUser = null;

try {
    // --- 1) Cria usuário no master (tabela usuarios) ---
    // Incluindo o DOCUMENTO aqui para garantir a unicidade futura
    $stmtUserMaster = $conn->prepare("
        INSERT INTO usuarios (nome, email, senha, documento, telefone, tipo_pessoa, nivel_acesso, status)
        VALUES (?, ?, ?, ?, ?, ?, 'admin', 'ativo')
    ");
    $stmtUserMaster->bind_param("ssssss", $nome, $email, $senha_hash, $documento, $telefone, $tipo_pessoa);
    $stmtUserMaster->execute();
    $usuarioMasterId = $conn->insert_id;
    $stmtUserMaster->close();

    if (!$usuarioMasterId) {
        throw new Exception("Falha grave ao criar o usuário mestre (ID não retornado).");
    }

    // --- 2) Gera tenant_id + Escolha Inteligente do Servidor (Sharding) ---
    $tenantId = md5(uniqid('', true));
    
    $servidoresDisponiveis = [
        'localhost',       
    ];

    $dbHost = 'localhost'; 
    
    try {
        $placeholders = implode(',', array_fill(0, count($servidoresDisponiveis), '?'));
        $types = str_repeat('s', count($servidoresDisponiveis));
        
        $sqlBalanceamento = "
            SELECT db_host, COUNT(*) as total 
            FROM tenants 
            WHERE db_host IN ($placeholders) 
            GROUP BY db_host 
            ORDER BY total ASC 
            LIMIT 1
        ";
        
        $stmtBal = $conn->prepare($sqlBalanceamento);
        if ($stmtBal) {
            $stmtBal->bind_param($types, ...$servidoresDisponiveis);
            $stmtBal->execute();
            $resBal = $stmtBal->get_result()->fetch_assoc();
            $stmtBal->close();

            if ($resBal && !empty($resBal['db_host'])) {
                $dbHost = $resBal['db_host'];
            } else {
                $dbHost = $servidoresDisponiveis[0];
            }
        }
    } catch (Exception $e) {
        error_log("Aviso: Falha no balanceamento de carga (usando localhost): " . $e->getMessage());
        $dbHost = 'localhost';
    }

    $dbName = 'tenant_db_' . $tenantId;
    $tenantUser = 'dbu_' . substr($tenantId, 0, 12);
    $tenantPass = bin2hex(random_bytes(16)); 

    // --- 3) Registra tenant no master ---
    $stmtTenant = $conn->prepare("
        INSERT INTO tenants (
            tenant_id, usuario_id, nome, nome_empresa, admin_email,
            subdominio, db_host, db_database, db_user, db_password,
            status_assinatura, role, data_inicio_teste, senha
        ) VALUES (?, ?, ?, ?, ?, NULL, ?, ?, ?, ?, 'ativo', 'usuario', CURDATE(), ?)
    ");

    $nome_empresa = $nome;
    $stmtTenant->bind_param(
        "sisssssssss", 
        $tenantId,
        $usuarioMasterId, 
        $nome,
        $nome_empresa,
        $email,
        $dbHost, 
        $dbName,
        $tenantUser,
        $tenantPass,
        $senha_hash
    );

    $stmtTenant->execute();
    if ($stmtTenant->affected_rows === 0) {
        throw new Exception("Falha ao registrar o tenant no banco de dados mestre.");
    }
    $stmtTenant->close();

    // --- 4) Cria banco do tenant ---
    if (!$conn->query("CREATE DATABASE IF NOT EXISTS `$dbName` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci")) {
        throw new Exception("Erro ao criar o banco de dados do tenant: " . $conn->error);
    }

    // --- 5) Cria usuário MySQL do tenant ---
    $conn->query("DROP USER IF EXISTS '$tenantUser'@'%'"); 
    if (!$conn->query("CREATE USER '$tenantUser'@'%' IDENTIFIED BY '$tenantPass'")) {
         throw new Exception("Erro ao criar o usuário MySQL para o tenant: " . $conn->error);
    }
    if (!$conn->query("GRANT ALL PRIVILEGES ON `$dbName`.* TO '$tenantUser'@'%'")) {
         throw new Exception("Erro ao conceder privilégios ao usuário do tenant: " . $conn->error);
    }
    $conn->query("FLUSH PRIVILEGES");

    // --- 6) Conecta no banco do tenant ---
    $tenantConn = new mysqli($dbHost, $tenantUser, $tenantPass, $dbName);
    if ($tenantConn->connect_error) {
        throw new Exception("Erro ao conectar ao banco do tenant recém-criado: " . $tenantConn->connect_error);
    }
    $tenantConn->set_charset("utf8mb4");

    // --- 7) Executa schema base ---
    $schemaPath = __DIR__ . '/../includes/tenant_schema.sql';
    if (!file_exists($schemaPath)) {
        throw new Exception("Arquivo tenant_schema.sql não encontrado. O registo falhou.");
    }

    $schemaSQL = file_get_contents($schemaPath);
    if (!$tenantConn->multi_query($schemaSQL)) {
        throw new Exception("Erro ao aplicar o schema no banco do tenant: " . $tenantConn->error);
    }
    while ($tenantConn->more_results() && $tenantConn->next_result()) {}

    // --- 8) Cria admin dentro do tenant ---
    $stmtUserTenant = $tenantConn->prepare("
        INSERT INTO usuarios (nome, email, senha, nivel_acesso, status, tipo_pessoa, documento, telefone, tenant_id)
        VALUES (?, ?, ?, 'admin', 'ativo', ?, ?, ?, ?)
    ");
    $stmtUserTenant->bind_param("sssssss", 
        $nome,
        $email,
        $senha_hash,
        $tipo_pessoa,
        $documento,
        $telefone,
        $tenantId
    );
    $stmtUserTenant->execute();
    $stmtUserTenant->close();
    $tenantConn->close();

    // --- Sucesso ---
    $_SESSION['registro_sucesso'] = "Cadastro concluído com sucesso!";
    header("Location: ../pages/login.php?msg=cadastro_sucesso");
    exit();

} catch (Exception $e) {

    // --- ROLLBACK MANUAL DE SEGURANÇA ---
    error_log("⛔ ERRO NO REGISTO: " . $e->getMessage());
    $_SESSION['erro_registro'] = "Erro ao criar sua conta. Por favor, tente novamente.";

    if (isset($dbName)) $conn->query("DROP DATABASE IF EXISTS `$dbName`");
    if (isset($tenantUser)) $conn->query("DROP USER IF EXISTS '$tenantUser'@'%'");
    
    if ($usuarioMasterId !== null) {
        $conn->begin_transaction();
        try {
            $stmtDeleteTenant = $conn->prepare("DELETE FROM tenants WHERE usuario_id = ?");
            $stmtDeleteTenant->bind_param("i", $usuarioMasterId);
            $stmtDeleteTenant->execute();
            $stmtDeleteTenant->close();

            $stmtDeleteUser = $conn->prepare("DELETE FROM usuarios WHERE id = ?");
            $stmtDeleteUser->bind_param("i", $usuarioMasterId);
            $stmtDeleteUser->execute();
            $stmtDeleteUser->close();
            
            $conn->commit();
        } catch (Exception $rollbackEx) {
            $conn->rollback();
            error_log("⛔ FALHA CRÍTICA NO ROLLBACK: " . $rollbackEx->getMessage());
        }
    }

    header("Location: ../pages/registro.php?msg=erro_generico");
    exit();
}
?>